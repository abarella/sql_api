<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard API - Vendas Internet</title>
    <link rel="icon" type="image/svg+xml" href="favicon.svg">
    <link rel="alternate icon" type="image/x-icon" href="favicon.ico">
    <link rel="stylesheet" href="style.css" />
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.11.5/css/jquery.dataTables.min.css">
    <style>
        body {
            margin: 0;
            padding-top: 85px; /* Espa√ßo para o cabe√ßalho fixo */
            font-size: 12px; /* Diminui a fonte global */
        }
        .container-main {
            display: flex;
            gap: 10px; /* Reduzido de 20px para 10px */
            padding: 10px; /* Reduzido de 20px para 10px */
            margin-top: 0;
        }
        .content-left {
            flex: 0 0 58%; /* Ajustado para compensar gap e padding */
        }
        .content-right {
            flex: 0 0 38%; /* Ajustado para compensar gap e padding */
            border-left: 2px solid #ccc;
            padding-left: 10px; /* Reduzido de 20px para 10px */
        }
        .header-title {
            text-align: center;
        }
        /* Ajusta o tamanho das tabelas */
        table {
            font-size: 11px;
        }
        /* Ajusta o tamanho das legends */
        legend {
            font-size: 16px !important;
        }
    </style>
</head>
<body>
    <div class="applicationname-light-login header-title">Ol√° Development Team!</div>
    
    <div class="container-main">
        <!-- √Årea de Visualiza√ß√£o (70%) -->
        <div class="content-left">
    <fieldset>
        <legend>Produ√ß√£o Hoje <span id="sumQtde">(0)</span></legend>
        <table id="minhaTabela" class="cell-border compact stripe hover" style="width:100%">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Produto</th>
                    <th>Lote</th>
                    <th>S√©rie</th>
                    <th>Qtde</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </fieldset>
    
    <hr>

    <fieldset>
        <legend>Nfs Agora <span id="countNfs">(0)</span></legend>
        <table id="minhaTabela1" class="cell-border compact stripe hover" style="width:100%">
        <thead>
            <tr>
                <th>nNf</th>
                <th>OID</th>
                <th>Emissor</th>
                <th>Tentativas</th>
                <th>UF</th>
                <th>Chave</th>
                <th>Serie</th>
                <th>Atividade</th>
                <th>Chave NF</th>
                <th>Transportadora</th>
            </tr>
        </thead>
        <tbody></tbody>
        </table>
    </fieldset>

    <hr>

    <fieldset>
        <legend>Produ√ß√£o Amanh√£ <span id="sumQtdeAmanha">(0)</span></legend>
        <table id="minhaTabela2" class="cell-border compact stripe hover" style="width:100%">
            <thead>
                <tr>
                    <th>Produto</th>
                    <th>Lote</th>
                    <th>S√©rie</th>
                    <th>Qtde</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </fieldset>
        </div>
        <!-- Fim √Årea de Visualiza√ß√£o (70%) -->

        <!-- √Årea de Opera√ß√µes PUT (30%) -->
        <div class="content-right">
            
            <fieldset>
                <legend>Opera√ß√µes</legend>
                
                <!-- Grupo: Zerar Tentativas -->
                <div style="margin-bottom: 15px; padding: 10px; border: 1px solid #ddd; border-radius: 5px; background-color: #f9f9f9;">
                    <label style="display: block; margin-bottom: 6px; font-weight: bold; font-size: 12px;">Zerar Tentativas NF:</label>
                    <div style="display: flex; gap: 6px; align-items: stretch;">
                        <input type="number" id="inputNotafisOid" placeholder="OID" 
                               style="flex: 1; padding: 6px; font-size: 11px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box;">
                        <button id="btnZerarTentativas" title="Zerar Tentativas" 
                                style="padding: 0 10px; font-size: 18px; background-color: transparent; color: #333; border: 1px solid #ccc; border-radius: 4px; cursor: pointer; display: flex; align-items: center; justify-content: center;">
                            üîÑ
                        </button>
                    </div>
                    <div id="mensagemResultado" style="margin-top: 8px; padding: 6px; border-radius: 4px; font-size: 11px; display: none;"></div>
                </div>
                
                <!-- Grupo: Gravar Autoriza√ß√£o -->
                <div style="margin-bottom: 20px; padding: 10px; border: 1px solid #ddd; border-radius: 5px; background-color: #f9f9f9;">
                    <label style="display: block; margin-bottom: 8px; font-weight: bold; font-size: 13px;">Gravar Autoriza√ß√£o:</label>
                    
                    <input type="text" id="inputChave" placeholder="Chave (44 caracteres)" maxlength="44"
                           style="width: 100%; padding: 6px; font-size: 11px; border: 1px solid #ccc; border-radius: 4px; margin-bottom: 6px; font-family: monospace; box-sizing: border-box;">
                    
                    <input type="text" id="inputAutorizacao" placeholder="Autoriza√ß√£o"
                           style="width: 100%; padding: 6px; font-size: 11px; border: 1px solid #ccc; border-radius: 4px; margin-bottom: 6px; box-sizing: border-box;">
                    
                    <input type="datetime-local" id="inputDataHora"
                           style="width: 100%; padding: 6px; font-size: 11px; border: 1px solid #ccc; border-radius: 4px; margin-bottom: 6px; box-sizing: border-box;">
                    
                    <button id="btnGravarAutorizacao" title="Gravar Autoriza√ß√£o" 
                            style="width: 100%; padding: 8px; font-size: 12px; background-color: #4CAF50; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; box-sizing: border-box;">
                        üíæ Gravar Autoriza√ß√£o
                    </button>
                    
                    <div id="mensagemAutorizacao" style="margin-top: 8px; padding: 6px; border-radius: 4px; font-size: 11px; display: none;"></div>
                </div>
                
            </fieldset>
        </div>
        <!-- Fim √Årea de Opera√ß√µes PUT (30%) -->
    </div>
    <!-- Fim Container Principal -->



    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
  

    <script>
        // Detecta o hostname atual e usa a URL correta da API
        var API_BASE_URL = window.location.hostname === 'localhost' 
            ? 'http://localhost:3000' 
            : 'http://' + window.location.hostname + ':3000';
        
        console.log('API Base URL:', API_BASE_URL);

        $(document).ready(function() {
        var tabela = $('#minhaTabela').DataTable({
            "ajax": {
                "url": API_BASE_URL + "/pedidos/producaohoje",
                "dataSrc": function(json) {
                    var soma = json.reduce(function(total, item) {
                        return total + (parseInt(item.regs) || 0);
                    }, 0);
                    $('#sumQtde').text('(' + soma + ')');
                    return json;
                }
            },
            "bPaginate": false,
            "bFilter": false,
            "bInfo": false,
            "language": {"url": "https://cdn.datatables.net/plug-ins/1.12.1/i18n/pt-BR.json"},
            "columns":  [
                { data: 'id' },
                { data: 'p110prod' },
                { data: 'p110lote' },
                { data: 'p110serie' },
                { data: 'regs' },
            ]
        });

        // Atualiza a tabela a cada 5 segundos (5000 milissegundos)
        setInterval(function() {
            tabela.ajax.reload();
        }, 5000);
    });


    $(document).ready(function() {
        var tabela = $('#minhaTabela1').DataTable({
            "ajax": {
                "url": API_BASE_URL + "/pedidos/nfandamento",
                "dataSrc": function(json) {
                    $('#countNfs').text('(' + json.length + ')');
                    return json;
                }
            },
            "bPaginate": false,
            "bFilter": false,
            "bInfo": false,
            "language": {"url": "https://cdn.datatables.net/plug-ins/1.12.1/i18n/pt-BR.json"},
            "columns":  [
                { data: 'nNF' },
                { data: 'notafis_oid' },
                { data: 'emissor' },
                { data: 'tentativas' },
                { data: 'enderdest_UF' },
                { data: 'p110chve' },
                { data: 'p110serie' },
                { data: 'p110atv' },
                { data: 'chave_acesso' },
                { data: 'p110trn2' },
                
                
            ]
        });

        // Atualiza a tabela a cada 5 segundos (5000 milissegundos)
        setInterval(function() {
            tabela.ajax.reload();
        }, 5000);
    });


    $(document).ready(function() {
        var tabela = $('#minhaTabela2').DataTable({
            "ajax": {
                "url": API_BASE_URL + "/pedidos/producaoamanha",
                "dataSrc": function(json) {
                    var soma = json.reduce(function(total, item) {
                        return total + (parseInt(item.regs) || 0);
                    }, 0);
                    $('#sumQtdeAmanha').text('(' + soma + ')');
                    return json;
                }
            },
            "bPaginate": false,
            "bFilter": false,
            "bInfo": false,
            "language": {"url": "https://cdn.datatables.net/plug-ins/1.12.1/i18n/pt-BR.json"},
            "columns":  [
                { data: 'p110prod' },
                { data: 'p110lote' },
                { data: 'p110serie' },
                { data: 'regs' },
            ]
        });

        // Atualiza a tabela a cada 5 segundos (5000 milissegundos)
        setInterval(function() {
            tabela.ajax.reload();
        }, 5000);
    });


    

    $(document).ready(function() {
        var tabela = $('#minhaTabela3').DataTable({
            "ajax": {
                "url": API_BASE_URL + "/pedidos/cobrancablindagem",
                "dataSrc": ""
            },
            "bPaginate": false,
            "bFilter": false,
            "bInfo": false,
            "language": {"url": "https://cdn.datatables.net/plug-ins/1.12.1/i18n/pt-BR.json"},
            "columns":  [
                { data: 'p110ccli' },
                { data: 'p110cres' },
                { data: 'cgc_cli' },
                { data: 'email' },
                { data: 'responsavel' },
                { data: 'raz_soc' },
                { data: 'siafi' },
            ]
        });

        // Atualiza a tabela a cada 5 segundos (5000 milissegundos)
        setInterval(function() {
            tabela.ajax.reload();
        }, 5000);
    });

    
    
    // Fun√ß√£o para o bot√£o Zerar Tentativas
    $(document).ready(function() {
        $('#btnZerarTentativas').on('click', function() {
            var notafisOid = $('#inputNotafisOid').val();
            var mensagemDiv = $('#mensagemResultado');
            
            // Valida√ß√£o
            if (!notafisOid || notafisOid.trim() === '') {
                mensagemDiv.css('background-color', '#f44336').css('color', 'white').text('Por favor, informe o Notafis OID').show();
                
                // Oculta a mensagem ap√≥s 3 segundos
                setTimeout(function() {
                    mensagemDiv.fadeOut();
                }, 3000);
                
                return;
            }
            
            if (confirm('Tem certeza que deseja zerar as tentativas da NF OID: ' + notafisOid + '?')) {
                // Desabilita o bot√£o durante a requisi√ß√£o
                var btnZerar = $('#btnZerarTentativas');
                btnZerar.prop('disabled', true).css('opacity', '0.5');
                
                $.ajax({
                    url: API_BASE_URL + '/pedidos/zerartentativas/' + notafisOid,
                    type: 'PUT',
                    contentType: 'application/json',
                    success: function(response) {
                        mensagemDiv.css('background-color', '#4CAF50').css('color', 'white')
                                   .text('Tentativas zeradas com sucesso!').show();
                        $('#inputNotafisOid').val(''); // Limpa o campo
                        
                        // Recarrega a tabela de NFs
                        $('#minhaTabela1').DataTable().ajax.reload();
                        
                        // Oculta a mensagem ap√≥s 3 segundos
                        setTimeout(function() {
                            mensagemDiv.fadeOut();
                        }, 3000);
                    },
                    error: function(xhr, status, error) {
                        var errorMsg = xhr.responseJSON && xhr.responseJSON.error 
                                       ? xhr.responseJSON.error 
                                       : 'Erro ao zerar tentativas';
                        mensagemDiv.css('background-color', '#f44336').css('color', 'white')
                                   .text(errorMsg).show();
                        
                        // Oculta a mensagem ap√≥s 3 segundos
                        setTimeout(function() {
                            mensagemDiv.fadeOut();
                        }, 3000);
                    },
                    complete: function() {
                        // Reabilita o bot√£o
                        btnZerar.prop('disabled', false).css('opacity', '1');
                    }
                });
            }
        });
    });

    // Fun√ß√£o para o bot√£o Gravar Autoriza√ß√£o
    $(document).ready(function() {
        // Define data/hora atual ao carregar a p√°gina
        var now = new Date();
        now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
        $('#inputDataHora').val(now.toISOString().slice(0, 16));
        
        $('#btnGravarAutorizacao').on('click', function() {
            var chave = $('#inputChave').val().trim();
            var autorizacao = $('#inputAutorizacao').val().trim();
            var dataHora = $('#inputDataHora').val();
            var mensagemDiv = $('#mensagemAutorizacao');
            
            // Valida√ß√µes
            if (!chave || !autorizacao || !dataHora) {
                mensagemDiv.css('background-color', '#f44336').css('color', 'white')
                           .text('Por favor, preencha todos os campos').show();
                setTimeout(function() { mensagemDiv.fadeOut(); }, 3000);
                return;
            }
            
            if (chave.length !== 44) {
                mensagemDiv.css('background-color', '#f44336').css('color', 'white')
                           .text('A chave deve ter exatamente 44 caracteres').show();
                setTimeout(function() { mensagemDiv.fadeOut(); }, 3000);
                return;
            }
            
            // Converte data para formato SQL Server (YYYYMMDD HH:mm:ss)
            var dataFormatada = dataHora.replace('T', ' ').replace(/-/g, '').substring(0, 8) + ' ' + 
                               dataHora.split('T')[1] + ':00';
            
            if (confirm('Tem certeza que deseja gravar a autoriza√ß√£o?\n\nChave: ' + chave + '\nAutoriza√ß√£o: ' + autorizacao)) {
                // Desabilita o bot√£o
                var btnGravar = $('#btnGravarAutorizacao');
                btnGravar.prop('disabled', true).css('opacity', '0.5');
                
                $.ajax({
                    url: API_BASE_URL + '/pedidos/gravarautorizacao',
                    type: 'PUT',
                    contentType: 'application/json',
                    data: JSON.stringify({
                        chave: chave,
                        autorizacao: autorizacao,
                        dataHora: dataFormatada
                    }),
                    success: function(response) {
                        mensagemDiv.css('background-color', '#4CAF50').css('color', 'white')
                                   .text('Autoriza√ß√£o gravada com sucesso!').show();
                        
                        // Limpa os campos
                        $('#inputChave').val('');
                        $('#inputAutorizacao').val('');
                        
                        // Redefine data/hora atual
                        var now = new Date();
                        now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
                        $('#inputDataHora').val(now.toISOString().slice(0, 16));
                        
                        // Recarrega a tabela de NFs
                        $('#minhaTabela1').DataTable().ajax.reload();
                        
                        setTimeout(function() { mensagemDiv.fadeOut(); }, 3000);
                    },
                    error: function(xhr, status, error) {
                        var errorMsg = xhr.responseJSON && xhr.responseJSON.error 
                                       ? xhr.responseJSON.error 
                                       : 'Erro ao gravar autoriza√ß√£o';
                        mensagemDiv.css('background-color', '#f44336').css('color', 'white')
                                   .text(errorMsg).show();
                        setTimeout(function() { mensagemDiv.fadeOut(); }, 3000);
                    },
                    complete: function() {
                        btnGravar.prop('disabled', false).css('opacity', '1');
                    }
                });
            }
        });
    });

    </script>


</body>
</html>

